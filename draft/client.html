<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>FastAPI Chat Test</title>
  <style>
    body { font-family: sans-serif; max-width: 900px; margin: 20px auto; }
    input, button { margin: 5px; padding: 5px; }
    textarea { width: 100%; height: 80px; }
    .chat-box { border: 1px solid #ccc; padding: 10px; margin-top: 10px; height: 200px; overflow-y: auto; }
  </style>
</head>
<body>
  <h1>üöÄ FastAPI Chat Test</h1>

  <h2>üîë –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è</h2>
  <div>
    <input id="username" placeholder="Username">
    <input id="password" type="password" placeholder="Password">
    <button onclick="signUp()">Sign Up</button>
    <button onclick="signIn()">Sign In</button>
  </div>
  <div>
    <button onclick="getCurrentUser()">/current-user</button>
    <button onclick="getAllUsers()">/full-list</button>
  </div>
  <pre id="authResult"></pre>

  <h2>üí¨ –ß–∞—Ç—ã</h2>
  <div>
    <input id="memberIds" placeholder="Member IDs (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)">
    <label><input id="isGroup" type="checkbox"> –ì—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç</label>
    <button onclick="createChat()">–°–æ–∑–¥–∞—Ç—å —á–∞—Ç</button>
    <button onclick="listChats()">–°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤</button>
  </div>
  <pre id="chatsResult"></pre>

  <h2>üì® –°–æ–æ–±—â–µ–Ω–∏—è</h2>
  <div>
    <input id="chatId" placeholder="Chat ID">
    <button onclick="getMessages()">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è</button>
  </div>
  <div class="chat-box" id="messagesBox"></div>

  <h2>üîó WebSocket</h2>
  <div>
    <input id="wsChatId" placeholder="Chat ID">
    <button onclick="connectWS()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
  </div>
  <div>
    <input id="wsMessage" placeholder="–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ">
    <button onclick="sendWSMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </div>
  <div class="chat-box" id="wsBox"></div>

<script>
const API_BASE = "http://0.0.0.0:8000";
let token = null;
let ws = null;

// --- AUTH ---
async function signUp() {
  const res = await fetch(`${API_BASE}/auth/sign-up`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      username: document.getElementById("username").value,
      password: document.getElementById("password").value
    })
  });
  const data = await res.json();
  token = data.access_token;
  document.getElementById("authResult").textContent = JSON.stringify(data, null, 2);
}

async function signIn() {
  const res = await fetch(`${API_BASE}/auth/sign-in`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      username: document.getElementById("username").value,
      password: document.getElementById("password").value
    })
  });
  const data = await res.json();
  token = data.access_token;
  document.getElementById("authResult").textContent = JSON.stringify(data, null, 2);
}

async function getCurrentUser() {
  const res = await fetch(`${API_BASE}/current-user`, {
    headers: { Authorization: "Bearer " + token }
  });
  document.getElementById("authResult").textContent = JSON.stringify(await res.json(), null, 2);
}

async function getAllUsers() {
  const res = await fetch(`${API_BASE}/full-list`, {
    headers: { Authorization: "Bearer " + token }
  });
  document.getElementById("authResult").textContent = JSON.stringify(await res.json(), null, 2);
}

// --- CHATS ---
async function createChat() {
  const ids = document.getElementById("memberIds").value.split(",").map(x => parseInt(x.trim())).filter(x => !isNaN(x));
  const isGroup = document.getElementById("isGroup").checked;
  const res = await fetch(`${API_BASE}/chats/`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer " + token
    },
    body: JSON.stringify({ member_ids: ids, is_group: isGroup })
  });
  document.getElementById("chatsResult").textContent = JSON.stringify(await res.json(), null, 2);
}

async function listChats() {
  const res = await fetch(`${API_BASE}/chats/`, {
    headers: { Authorization: "Bearer " + token }
  });
  document.getElementById("chatsResult").textContent = JSON.stringify(await res.json(), null, 2);
}

// --- MESSAGES ---
async function getMessages() {
  const chatId = document.getElementById("chatId").value;
  const res = await fetch(`${API_BASE}/chats/${chatId}/messages`, {
    headers: { Authorization: "Bearer " + token }
  });
  const data = await res.json();
  const box = document.getElementById("messagesBox");
  box.innerHTML = "";
  data.forEach(msg => {
    const div = document.createElement("div");
    div.textContent = `${msg.sender_id}: ${msg.content}`;
    box.appendChild(div);
  });
}

// --- WEBSOCKET ---
function connectWS() {
  const chatId = document.getElementById("wsChatId").value;
  if (!token) {
    alert("–°–Ω–∞—á–∞–ª–∞ –∑–∞–ª–æ–≥–∏–Ω—å—Å—è!");
    return;
  }
  ws = new WebSocket(`ws://0.0.0.0:8000/ws/chats/${chatId}?token=${token}`);
  ws.onopen = () => {
    const box = document.getElementById("wsBox");
    box.innerHTML += "<div>‚úÖ Connected</div>";
  };
  ws.onmessage = (event) => {
    const box = document.getElementById("wsBox");
    box.innerHTML += "<div>" + event.data + "</div>";
    box.scrollTop = box.scrollHeight;
  };
  ws.onclose = () => {
    const box = document.getElementById("wsBox");
    box.innerHTML += "<div>‚ùå Disconnected</div>";
  };
}

function sendWSMessage() {
  const msg = document.getElementById("wsMessage").value;
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ content: msg }));
    document.getElementById("wsMessage").value = "";
  }
}
</script>
</body>
</html>
